---
- name: Collect data from other roles for AI analysis
  delegate_to: localhost
  vars:
    combined_data: |
      === Linux Base ===
      {{ linux_base_content | default('No data') }}

      === Systemd Checks ===
      {{ systemd_checks_content | default('No data') }}

      === Security Baseline ===
      {{ security_baseline_content | default('No data') }}

      === User Audit ===
      {{ user_audit_content | default('No data') }}

      === Auth Audit ===
      {{ auth_audit_content | default('No data') }}

      === Network Audit ===
      {{ network_audit_content | default('No data') }}

      === Time Sync ===
      {{ time_sync_content | default('No data') }}

      === Compliance (CIS) ===
      {{ compliance_cis_content | default('No data') }}

      === NGINX Check ===
      {{ nginx_content | default('No data') }}

      === Logs Collected ===
      {{ logs_collect_content | default('No data') }}

      === Updates Status ===
      {{ updates_readonly_content | default('No data') }}
  set_fact:
    ai_combined_data: "{{ combined_data }}"

- name: Set default AI provider
  delegate_to: localhost
  set_fact:
    ai_provider: "{{ ai_provider | default('openai') }}"

- name: Check OpenAI API key is provided
  delegate_to: localhost
  fail:
    msg: "OpenAI API key not provided. Set 'openai_api_key' variable to enable AI analysis."
  when: ai_provider == 'openai' and (openai_api_key is not defined or openai_api_key == '')

- name: Check Gemini API key is provided
  delegate_to: localhost
  fail:
    msg: "Gemini API key not provided. Set 'gemini_api_key' variable to enable AI analysis."
  when: ai_provider == 'google' and (gemini_api_key is not defined or gemini_api_key == '')

- name: Call OpenAI API for SRE analysis
  delegate_to: localhost
  uri:
    url: "https://api.openai.com/v1/chat/completions"
    method: POST
    headers:
      Authorization: "Bearer {{ openai_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      model: "gpt-3.5-turbo"
      messages:
        - role: "system"
          content: "You are a Senior Site Reliability Engineer (SRE) performing a system audit. Analyze the following snapshot data from a Linux server. Identify anomalies (e.g., services down, error logs, high resource usage, security issues). Provide concise diagnostic steps (short actionable items) in bullet points. Keep response under 300 words."
        - role: "user"
          content: "{{ ai_combined_data }}"
      temperature: 0.2
      max_tokens: 500
  register: ai_response
  ignore_errors: true
  failed_when: false
  when: ai_provider == 'openai'

- name: Call Google Gemini API for SRE analysis
  delegate_to: localhost
  uri:
    url: "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={{ gemini_api_key }}"
    method: POST
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      contents:
        - parts:
            - text: "You are a Senior Site Reliability Engineer (SRE) performing a system audit. Analyze the following snapshot data from a Linux server. Identify anomalies (e.g., services down, error logs, high resource usage, security issues). Provide concise diagnostic steps (short actionable items) in bullet points. Keep response under 300 words.\n\n{{ ai_combined_data }}"
  register: ai_response
  ignore_errors: true
  failed_when: false
  when: ai_provider == 'google'

- name: Extract AI analysis from OpenAI response
  delegate_to: localhost
  set_fact:
    ai_analysis_content: "{{ ai_response.json.choices[0].message.content }}"
  when: ai_provider == 'openai' and ai_response.json is defined and ai_response.json.choices[0].message.content is defined

- name: Extract AI analysis from Gemini response
  delegate_to: localhost
  set_fact:
    ai_analysis_content: "{{ ai_response.json.candidates[0].content.parts[0].text }}"
  when: ai_provider == 'google' and ai_response.json is defined and ai_response.json.candidates[0].content.parts[0].text is defined

- name: Set default AI analysis content on failure
  delegate_to: localhost
  set_fact:
    ai_analysis_content: "AI analysis could not be performed. Error: {{ ai_response.msg | default('Unknown error') }}"
  when: (ai_provider == 'openai' and (ai_response.json is not defined or ai_response.json.choices[0].message.content is not defined)) or (ai_provider == 'google' and (ai_response.json is not defined or ai_response.json.candidates[0].content.parts[0].text is not defined))

- name: Save AI analysis to file
  delegate_to: localhost
  copy:
    dest: "{{ output_dir }}/ai_analysis.txt"
    content: "{{ ai_analysis_content }}"
    mode: '0644'
  ignore_errors: true
  failed_when: false
