---
- name: Gather OS information
  shell: |
    cat /etc/os-release | grep -E "^(NAME|VERSION)="
  register: os_info
  changed_when: false
  ignore_errors: true

- name: Get kernel version
  shell: uname -r
  register: kernel_version
  changed_when: false
  ignore_errors: true

- name: Get system uptime
  shell: uptime
  register: uptime_info
  changed_when: false
  ignore_errors: true

- name: Get CPU info
  shell: lscpu | grep -E "^(CPU\(s\):|Model name|Architecture)"
  register: cpu_info
  changed_when: false
  ignore_errors: true

- name: Get memory usage
  shell: free -h
  register: memory_info
  changed_when: false
  ignore_errors: true

- name: Get memory usage percent
  shell: free | awk '/Mem:/ {printf \"%d\", ($3/$2)*100}'
  register: mem_usage_pct
  changed_when: false
  ignore_errors: true

- name: Get disk usage
  shell: df -h
  register: disk_info
  changed_when: false
  ignore_errors: true

- name: Get max disk usage percent
  shell: df -P | awk 'NR>1 {gsub(/%/,\"\",$5); if ($5>max) max=$5} END {print max+0}'
  register: disk_usage_max_pct
  changed_when: false
  ignore_errors: true

- name: Get load average (1m)
  shell: awk '{print $1}' /proc/loadavg
  register: load_avg_1m
  changed_when: false
  ignore_errors: true

- name: Get top processes by CPU
  shell: ps aux --sort=-%cpu | head -10
  register: top_cpu
  changed_when: false
  ignore_errors: true

- name: Get top processes by memory
  shell: ps aux --sort=-%mem | head -10
  register: top_mem
  changed_when: false
  ignore_errors: true

- name: Get listening ports
  shell: ss -tulpn
  register: listening_ports
  changed_when: false
  ignore_errors: true

- name: Check ESET service status
  shell: systemctl status eset 2>/dev/null || echo 'ESET not found'
  register: eset_status
  changed_when: false
  ignore_errors: true

- name: List all services
  shell: systemctl list-units --type=service --all
  register: all_services
  changed_when: false
  ignore_errors: true

- name: Set linux_base content fact
  set_fact:
    linux_base_metrics:
      disk_usage_max_pct: "{{ disk_usage_max_pct.stdout | default('0') | int }}"
      mem_usage_pct: "{{ mem_usage_pct.stdout | default('0') | int }}"
      load_avg_1m: "{{ load_avg_1m.stdout | default('0') | float }}"
    linux_base_warnings: >-
      {{
        []
        + ([\"Disk usage high: \" ~ (disk_usage_max_pct.stdout | default('0') | int) ~ \"%\"] if (disk_usage_max_pct.stdout | default('0') | int) >= (profile.thresholds.disk_usage_warn | default(80)) else [])
        + ([\"Memory usage high: \" ~ (mem_usage_pct.stdout | default('0') | int) ~ \"%\"] if (mem_usage_pct.stdout | default('0') | int) >= (profile.thresholds.memory_usage_warn | default(90)) else [])
        + ([\"Load average high: \" ~ (load_avg_1m.stdout | default('0') | float)] if (load_avg_1m.stdout | default('0') | float) >= (profile.thresholds.load_average_warn | default(2.0)) else [])
      }}
    linux_base_content: "{{ ['OS Info:', os_info.stdout_lines | join('\\n'), '', 'Kernel: ' ~ kernel_version.stdout, '', 'Uptime: ' ~ uptime_info.stdout, '', 'CPU Info:', cpu_info.stdout_lines | join('\\n'), '', 'Memory:', memory_info.stdout_lines | join('\\n'), '', 'Disk:', disk_info.stdout_lines | join('\\n'), '', 'Load Avg 1m: ' ~ (load_avg_1m.stdout | default('0')), '', 'Top CPU Processes:', top_cpu.stdout_lines | join('\\n'), '', 'Top Memory Processes:', top_mem.stdout_lines | join('\\n'), '', 'Listening Ports:', listening_ports.stdout_lines | default([]) | join('\\n'), '', 'ESET Status:', eset_status.stdout_lines | default([]) | join('\\n'), '', 'All Services:', all_services.stdout_lines | default([]) | join('\\n')] | join('\\n') }}"

- name: Save collected data to file
  delegate_to: localhost
  copy:
    dest: "{{ output_dir }}/linux_base.txt"
    content: "{{ linux_base_content }}"
    mode: '0644'
  ignore_errors: true
  failed_when: false
