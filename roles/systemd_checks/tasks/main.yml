---
- name: Check status of defined services
  block:
    - name: Get service status
      shell: systemctl is-active {{ item }}
      register: service_status
      loop: "{{ profile.services }}"
      failed_when: false
      changed_when: false

    - name: Generate systemd checks content
      delegate_to: localhost
      shell: |
        cat << 'EOF'
        {% for item in service_status.results %}
        Service: {{ item.item }} - Status: {{ item.stdout }}
        {% endfor %}
        EOF
      args:
        executable: /bin/bash
      register: systemd_checks_content_raw
      ignore_errors: true
      failed_when: false

    - name: Set systemd checks content fact
      set_fact:
        systemd_checks_content: "{{ systemd_checks_content_raw.stdout }}"
        systemd_inactive_services: "{{ service_status.results | selectattr('stdout', 'ne', 'active') | map(attribute='item') | list }}"

    - name: Set systemd warnings fact
      set_fact:
        systemd_warnings: "{{ ([ 'Inactive services: ' ~ (systemd_inactive_services | join(', ')) ] if (systemd_inactive_services | length > 0) else []) }}"

    - name: Save service statuses
      delegate_to: localhost
      copy:
        dest: "{{ output_dir }}/systemd_checks.txt"
        content: "{{ systemd_checks_content }}"
        mode: '0644'
      ignore_errors: true
      failed_when: false
  when: profile.services is defined
